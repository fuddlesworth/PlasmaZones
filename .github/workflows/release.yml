# PlasmaZones Release Pipeline
# Builds distribution packages when a version tag is pushed
# SPDX-License-Identifier: GPL-3.0-or-later

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    # Allow manual triggers

permissions:
  contents: write

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Extract version from tag
  # ═══════════════════════════════════════════════════════════════════════════
  version:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # ═══════════════════════════════════════════════════════════════════════════
  # Build Debian Package (Ubuntu 25.10 - has KF6)
  # ═══════════════════════════════════════════════════════════════════════════
  build-deb:
    name: Build .deb (Ubuntu 25.10)
    needs: version
    runs-on: ubuntu-latest
    container:
      image: ubuntu:questing

    steps:
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y --no-install-recommends git ca-certificates

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get install -y --no-install-recommends \
            cmake ninja-build extra-cmake-modules gettext g++ pkg-config \
            build-essential pkg-kde-tools \
            devscripts debhelper fakeroot dpkg-dev \
            qt6-base-dev qt6-base-private-dev qt6-declarative-dev qt6-tools-dev qt6-shadertools-dev \
            kwin-dev libwayland-dev libepoxy-dev libdrm-dev libxkbcommon-dev \
            libkf6config-dev libkf6configwidgets-dev libkf6coreaddons-dev \
            libkf6dbusaddons-dev libkf6i18n-dev libkf6kcmutils-dev \
            libkf6windowsystem-dev libkf6globalaccel-dev \
            libkf6notifications-dev libkf6colorscheme-dev \
            liblayershellqtinterface-dev libplasmaactivities-dev

      - name: Generate Debian changelog from CHANGELOG.md
        run: bash packaging/generate-changelog.sh debian

      - name: Build Debian package
        run: |
          # dpkg-buildpackage expects debian/ at project root
          ln -s packaging/debian debian
          dpkg-buildpackage -us -uc -b
          mkdir -p dist
          mv ../*.deb dist/
          # Include debug symbol packages (.ddeb) if generated
          mv ../*.ddeb dist/ 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-ubuntu-25.10
          path: dist/*.*deb
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # Build RPM Package
  # ═══════════════════════════════════════════════════════════════════════════
  build-rpm:
    name: Build .rpm (Fedora 43)
    needs: version
    runs-on: ubuntu-latest
    container:
      image: fedora:43

    steps:
      - name: Install prerequisites
        run: dnf install -y git rpm-build rpmdevtools

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            cmake ninja-build extra-cmake-modules gettext gcc-c++ \
            qt6-qtbase-devel qt6-qtbase-private-devel \
            qt6-qtdeclarative-devel qt6-qttools-devel qt6-qtshadertools-devel \
            kwin-devel wayland-devel libepoxy-devel libdrm-devel \
            kf6-kconfig-devel kf6-kconfigwidgets-devel \
            kf6-kcoreaddons-devel kf6-kdbusaddons-devel \
            kf6-ki18n-devel kf6-kcmutils-devel \
            kf6-kwindowsystem-devel kf6-kglobalaccel-devel \
            kf6-knotifications-devel kf6-kcolorscheme-devel \
            layer-shell-qt-devel plasma-activities-devel

      - name: Setup rpmbuild
        run: rpmdev-setuptree

      - name: Create source tarball
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          mkdir -p PlasmaZones-${VERSION}
          # Copy source files (exclude .git and build artifacts)
          tar --exclude='.git' --exclude='build' -cf - . | tar -xf - -C PlasmaZones-${VERSION}/
          tar czf ~/rpmbuild/SOURCES/plasmazones-${VERSION}.tar.gz PlasmaZones-${VERSION}

      - name: Generate RPM changelog and set version from CHANGELOG.md
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          sed -i "s/^Version:.*/Version:        $VERSION/" packaging/rpm/plasmazones.spec
          bash packaging/generate-changelog.sh rpm

      - name: Build RPM
        run: |
          cp packaging/rpm/plasmazones.spec ~/rpmbuild/SPECS/
          rpmbuild -bb ~/rpmbuild/SPECS/plasmazones.spec
          mkdir -p dist
          cp ~/rpmbuild/RPMS/*/*.rpm dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fedora-43
          path: dist/*.rpm
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # Build Generic Linux Tarball (Portable)
  # ═══════════════════════════════════════════════════════════════════════════
  build-generic:
    name: Build Tarball (Linux x86_64)
    needs: version
    runs-on: ubuntu-latest
    container:
      image: fedora:43

    steps:
      - name: Install prerequisites
        run: dnf install -y git tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            cmake ninja-build extra-cmake-modules gettext gcc-c++ \
            qt6-qtbase-devel qt6-qtbase-private-devel \
            qt6-qtdeclarative-devel qt6-qttools-devel qt6-qtshadertools-devel \
            kwin-devel wayland-devel libepoxy-devel libdrm-devel \
            kf6-kconfig-devel kf6-kconfigwidgets-devel \
            kf6-kcoreaddons-devel kf6-kdbusaddons-devel \
            kf6-ki18n-devel kf6-kcmutils-devel \
            kf6-kwindowsystem-devel kf6-kglobalaccel-devel \
            kf6-knotifications-devel kf6-kcolorscheme-devel \
            layer-shell-qt-devel plasma-activities-devel

      - name: Configure
        run: |
          # Install to /usr inside the AppDir
          # The installer script will copy this structure to ~/.local
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Install to AppDir
        run: |
          mkdir -p AppDir
          DESTDIR="${PWD}/AppDir" cmake --install build

      - name: Prepare tarball
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          DIRNAME="plasmazones-linux-x86_64"
          
          mkdir -p "$DIRNAME"
          mv AppDir/usr "$DIRNAME/"
          
          # Copy installer and uninstaller scripts to root of tarball
          cp packaging/local-install/install.sh "$DIRNAME/"
          cp packaging/local-install/uninstall.sh "$DIRNAME/"
          chmod +x "$DIRNAME/install.sh"
          chmod +x "$DIRNAME/uninstall.sh"
          
          # Create VERSION file for version detection
          echo "$VERSION" > "$DIRNAME/VERSION"
          
          # Copy uninstall.sh to the installed location so it's available after install
          mkdir -p "$DIRNAME/usr/share/plasmazones"
          cp packaging/local-install/uninstall.sh "$DIRNAME/usr/share/plasmazones/"
          chmod +x "$DIRNAME/usr/share/plasmazones/uninstall.sh"
          
          # Create tarball
          tar czf plasmazones-${VERSION}-linux-x86_64.tar.gz "$DIRNAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: generic-linux-tarball
          path: plasmazones-*-linux-x86_64.tar.gz
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # Build Arch Package
  # ═══════════════════════════════════════════════════════════════════════════
  build-arch:
    name: Build .pkg.tar.zst (Arch)
    needs: version
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Setup build environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo namcap

          # Create non-root user (makepkg refuses to run as root)
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          pacman -S --noconfirm --needed \
            cmake ninja extra-cmake-modules gettext \
            qt6-base qt6-declarative qt6-tools \
            kwin \
            kconfig kconfigwidgets kcoreaddons kdbusaddons \
            ki18n kcmutils kwindowsystem kglobalaccel \
            knotifications kcolorscheme \
            layer-shell-qt plasma-activities

      - name: Prepare PKGBUILD
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          cd packaging/arch

          # Update version in PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD

          # For CI, build from local source instead of downloading tarball
          # Create a modified PKGBUILD that uses local source
          cat > PKGBUILD.ci << 'PKGBUILD_EOF'
          # CI Build - uses local source
          pkgname=plasmazones
          pkgver=${{ needs.version.outputs.version }}
          pkgrel=1
          pkgdesc="FancyZones-style window tiling for KDE Plasma"
          arch=('x86_64')
          url="https://github.com/fuddlesworth/PlasmaZones"
          license=('GPL-3.0-or-later')
          depends=(
              'qt6-base' 'qt6-declarative'
              'kconfig' 'kconfigwidgets' 'kcoreaddons' 'kdbusaddons'
              'ki18n' 'kcmutils' 'kwindowsystem' 'kglobalaccel'
              'knotifications' 'kcolorscheme' 'layer-shell-qt'
          )
          makedepends=('cmake' 'extra-cmake-modules' 'qt6-tools' 'ninja')
          optdepends=('plasma-activities: activity-based layouts')
          source=()
          sha256sums=()
          install=plasmazones.install

          build() {
              cd "$startdir/../.."
              cmake -B build -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_INSTALL_LIBDIR=lib \
                  -DBUILD_TESTING=OFF \
                  -Wno-dev
              cmake --build build --parallel
          }

          package() {
              cd "$startdir/../.."
              DESTDIR="$pkgdir" cmake --install build

              # Install pacman hooks
              install -Dm644 packaging/arch/kbuildsycoca.hook \
                  "$pkgdir/usr/share/libalpm/hooks/plasmazones-kbuildsycoca.hook"
              install -Dm755 packaging/arch/plasmazones-refresh-sycoca \
                  "$pkgdir/usr/share/libalpm/scripts/plasmazones-refresh-sycoca"
          }
          PKGBUILD_EOF

      - name: Build package
        run: |
          chown -R builder:builder .
          cd packaging/arch
          su builder -c "makepkg -p PKGBUILD.ci -sf --noconfirm"

      - name: Validate package
        run: |
          cd packaging/arch
          namcap *.pkg.tar.zst || true

      - name: Move artifacts
        run: |
          mkdir -p dist
          mv packaging/arch/*.pkg.tar.zst dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: dist/*.pkg.tar.zst
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # Verify Nix Build
  # ═══════════════════════════════════════════════════════════════════════════
  build-nix:
    name: Verify Nix Build
    needs: version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Build
        run: |
          nix-build --expr '
            let pkgs = import (fetchTarball "https://github.com/NixOS/nixpkgs/archive/nixos-unstable.tar.gz") {};
            in pkgs.callPackage ./packaging/nix/package.nix { src = ./.; }
          '

      - name: Verify package version
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          echo "Expected version: $VERSION"
          result/bin/plasmazonesd --version || true

      - name: Generate release package.nix
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          TARBALL="https://github.com/fuddlesworth/PlasmaZones/archive/refs/tags/v${VERSION}.tar.gz"
          echo "Fetching source hash for $TARBALL"
          NIX_HASH=$(nix-prefetch-url --unpack "$TARBALL" 2>/dev/null)
          SRI_HASH=$(nix hash to-sri --type sha256 "$NIX_HASH")
          echo "SRI hash: $SRI_HASH"

          # Transform packaging/nix/package.nix into a standalone release file
          # by replacing src parameter with fetchFromGitHub and baking in version/hash
          awk -v version="$VERSION" -v hash="$SRI_HASH" '
            # Replace header comments with release usage
            NR == 1 {
              print "# PlasmaZones " version " — Nix package"
              print "# SPDX-License-Identifier: GPL-3.0-or-later"
              print "#"
              print "# Usage:"
              print "#   environment.systemPackages = ["
              print "#     (pkgs.callPackage ./plasmazones.nix {})"
              print "#   ];"
              next
            }
            # Skip remaining header comments
            !started && /^#/ { next }
            !started && /^$/ { next }
            # Begin processing at the parameter list
            /^\{/ { started = 1 }
            # Replace src parameter with fetchFromGitHub
            started && /^  src,$/ { print "  fetchFromGitHub,"; next }
            # Skip the extractVersion let/in block
            /^let$/ { in_let = 1; next }
            in_let && /^in$/ { in_let = 0; next }
            in_let { next }
            # Replace dynamic version with hardcoded
            /version = extractVersion src;/ {
              print "  version = \"" version "\";"
              next
            }
            # Replace inherit src with fetchFromGitHub block
            /inherit src;/ {
              print "  src = fetchFromGitHub {"
              print "    owner = \"fuddlesworth\";"
              print "    repo = \"PlasmaZones\";"
              print "    rev = \"v" version "\";"
              print "    hash = \"" hash "\";"
              print "  };"
              next
            }
            # Pass through everything else
            !in_let { print }
          ' packaging/nix/package.nix > plasmazones.nix

          echo "=== Generated plasmazones.nix ==="
          cat plasmazones.nix

      - name: Upload Nix package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nix-package
          path: plasmazones.nix
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # Create GitHub Release
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    name: Create GitHub Release
    needs: [version, build-deb, build-rpm, build-arch, build-generic, build-nix]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Generate release notes from CHANGELOG.md
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          {
            echo "## PlasmaZones v${VERSION}"
            echo ""
            bash packaging/generate-changelog.sh notes "$VERSION"
            echo ""
            echo "### Installation"
            echo ""
            echo "**Arch Linux (AUR):**"
            echo '```bash'
            echo "yay -S plasmazones  # or plasmazones-bin"
            echo '```'
            echo ""
            echo "**Arch Linux (manual):**"
            echo '```bash'
            echo "sudo pacman -U plasmazones-${VERSION}-1-x86_64.pkg.tar.zst"
            echo '```'
            echo ""
            echo "**Ubuntu/Debian (25.10+):**"
            echo '```bash'
            echo "sudo dpkg -i plasmazones_${VERSION}-1_amd64.deb"
            echo "sudo apt-get install -f  # Install dependencies if needed"
            echo '```'
            echo ""
            echo "**Fedora:**"
            echo '```bash'
            echo "sudo dnf install plasmazones-${VERSION}-1.fc43.x86_64.rpm"
            echo '```'
            echo ""
            echo "**Universal Linux (AppDir):**"
            echo "For Fedora Atomic, Steam Deck, or non-root user installation:"
            echo '```bash'
            echo "tar xzf plasmazones-${VERSION}-linux-x86_64.tar.gz"
            echo "cd plasmazones-linux-x86_64"
            echo "./install.sh"
            echo '```'
            echo ""
            echo "**NixOS:**"
            echo "Download \`plasmazones.nix\` from the release assets, then:"
            echo '```nix'
            echo "# configuration.nix"
            echo "environment.systemPackages = ["
            echo "  (pkgs.callPackage ./plasmazones.nix {})"
            echo "];"
            echo '```'
            echo ""
            echo "### Post-Installation"
            echo ""
            echo '```bash'
            echo "systemctl --user enable --now plasmazones.service"
            echo "systemsettings kcm_plasmazones"
            echo '```'
          } > release_notes.md

      - name: Delete existing release if present
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ needs.version.outputs.version }}"
          if gh release view "$VERSION" &>/dev/null; then
            echo "Release $VERSION already exists — deleting so we can recreate with assets"
            gh release delete "$VERSION" --yes
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: PlasmaZones v${{ needs.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'beta') || contains(needs.version.outputs.version, 'rc') }}
          files: |
            artifacts/**/*.*deb
            artifacts/**/*.rpm
            artifacts/**/*.pkg.tar.zst
            artifacts/**/*linux-x86_64.tar.gz
            artifacts/**/plasmazones.nix
          generate_release_notes: false
          make_latest: true

  # ═══════════════════════════════════════════════════════════════════════════
  # Publish to AUR (Arch User Repository)
  # ═══════════════════════════════════════════════════════════════════════════
  publish-aur:
    name: Publish to AUR
    needs: [version, release]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.version.outputs.version, 'alpha') && !contains(needs.version.outputs.version, 'beta') && !contains(needs.version.outputs.version, 'rc') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Arch package artifact
        uses: actions/download-artifact@v4
        with:
          name: arch-package
          path: dist

      - name: Calculate package hash
        id: hash
        run: |
          PKG_FILE=$(ls dist/*.pkg.tar.zst | head -1)
          SHA256=$(sha256sum "$PKG_FILE" | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Package: $PKG_FILE"
          echo "SHA256: $SHA256"

      - name: Setup SSH for AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat >> ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking accept-new
          EOF
          chmod 600 ~/.ssh/config

      - name: Clone and update AUR repository (plasmazones-bin)
        env:
          VERSION: ${{ needs.version.outputs.version }}
          SHA256: ${{ steps.hash.outputs.sha256 }}
        run: |
          git clone ssh://aur@aur.archlinux.org/plasmazones-bin.git /tmp/aur-bin
          cd /tmp/aur-bin

          # Copy files from source repo
          cp "$GITHUB_WORKSPACE/packaging/arch/PKGBUILD.bin" ./PKGBUILD
          cp "$GITHUB_WORKSPACE/packaging/arch/plasmazones.install" ./
          cp "$GITHUB_WORKSPACE/packaging/arch/LICENSE" ./

          # Update version and hash
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/'[a-f0-9]\{64\}'/'$SHA256'/" PKGBUILD

          # Generate .SRCINFO (mount files read-only to avoid chown breaking host git)
          docker run --rm \
            -v "$(pwd)/PKGBUILD:/build/PKGBUILD:ro" \
            -v "$(pwd)/plasmazones.install:/build/plasmazones.install:ro" \
            archlinux:latest bash -c "
            pacman -Sy --noconfirm pacman >&2
            useradd -m builder
            cp /build/* /home/builder/
            chown builder:builder /home/builder/*
            su builder -c 'cd /home/builder && makepkg --printsrcinfo'
          " > .SRCINFO

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update to $VERSION"
            git push
            echo "✅ Published plasmazones-bin $VERSION to AUR"
          fi

      - name: Clone and update AUR repository (plasmazones - source)
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          git clone ssh://aur@aur.archlinux.org/plasmazones.git /tmp/aur-src
          cd /tmp/aur-src

          # Copy files from source repo
          cp "$GITHUB_WORKSPACE/packaging/arch/PKGBUILD" ./
          cp "$GITHUB_WORKSPACE/packaging/arch/plasmazones.install" ./
          cp "$GITHUB_WORKSPACE/packaging/arch/LICENSE" ./

          # Update version
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          # Calculate and update source tarball hash
          TARBALL_URL="https://github.com/fuddlesworth/PlasmaZones/archive/refs/tags/v${VERSION}.tar.gz"
          TARBALL_SHA256=$(curl -sL "$TARBALL_URL" | sha256sum | cut -d' ' -f1)
          echo "Source tarball SHA256: $TARBALL_SHA256"
          sed -i "s/'[a-f0-9]\{64\}'/'$TARBALL_SHA256'/" PKGBUILD

          # Generate .SRCINFO (mount files read-only to avoid chown breaking host git)
          docker run --rm \
            -v "$(pwd)/PKGBUILD:/build/PKGBUILD:ro" \
            -v "$(pwd)/plasmazones.install:/build/plasmazones.install:ro" \
            archlinux:latest bash -c "
            pacman -Sy --noconfirm pacman >&2
            useradd -m builder
            cp /build/* /home/builder/
            chown builder:builder /home/builder/*
            su builder -c 'cd /home/builder && makepkg --printsrcinfo'
          " > .SRCINFO

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update to $VERSION"
            git push
            echo "✅ Published plasmazones $VERSION to AUR"
          fi
